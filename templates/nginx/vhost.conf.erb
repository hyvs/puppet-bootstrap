server {
    listen      <%= @listen %>;
    server_name <%= @server_name %>;
    <%- if @type != 'proxy' -%>
    root        <%= @docroot %>;
    <%- end -%>

    <%- if @type == 'phpfpm_symfony2' -%>
    location / {
        try_files $uri /app.php$is_args$args;
    <%- if defined?(@params['cors']) and @params['cors'] == 'wide-open' %>
         if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
         }
         if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
         if ($request_method = 'GET') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
    <%- end -%>
    }
        <%- if defined?(@params['dev']) and @params['dev'] %>
    location ~ ^/app_dev\.php(/|$) {
        fastcgi_pass            <%= @params['socket'] %>;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include                 fastcgi_params;
        fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param           HTTPS           off;
    }
        <%- end -%>
    location ~ ^/app\.php(/|$) {
        fastcgi_pass            <%= @params['socket'] %>;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include                 fastcgi_params;
        fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param           HTTPS off;
        internal;
        gzip                    on;
        gzip_comp_level         3;
    }
    location ~ ^/assets/c/nc/.+ {
        expires 0;
        gzip    off;
    }
    location ~ ^/assets/c/5m/.+ {
        expires 5m;
        gzip    off;
    }
    location ~ ^/assets/c/h/.+ {
        expires 1h;
        gzip    off;
    }
    location ~ ^/assets/c/d/.+ {
        expires 1d;
        gzip    off;
    }
    location ~ ^/assets/c/w/.+ {
        expires 1w;
        gzip    off;
    }
    location ~ ^/assets/c/2w/.+ {
        expires 2w;
        gzip    off;
    }
    location ~ ^/assets/c/m/.+ {
        expires 1M;
        gzip    off;
    }
    <%- elsif @type == 'phpfpm' -%>
    location / {
        try_files $uri /index.php$is_args$args;
        fastcgi_pass            <%= @params['socket'] %>;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include                 fastcgi_params;
        fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param           HTTPS off;
    <%- if defined?(@params['cors']) and @params['cors'] == 'wide-open' %>
         if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
         }
         if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
         if ($request_method = 'GET') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
    <%- end -%>
    }
    <%- elsif @type == 'proxy' -%>
    location / {
        proxy_pass <%= @params['proxy_path'] %>;
        <%- if defined?(@params['restricted']) %>
        auth_basic Restricted;
        auth_basic_user_file /etc/nginx/.htpasswd;
        <%- end -%>
    }
    <%- else -%>
    location / {
        try_files $uri =404;
    <%- if defined?(@params['cors']) and @params['cors'] == 'wide-open' %>
         if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
         }
         if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
         if ($request_method = 'GET') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
         }
    <%- end -%>
    }
    <%- end -%>

    error_log /var/log/nginx/project_error.log;
    access_log /var/log/nginx/project_access.log app;
}